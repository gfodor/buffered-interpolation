const INITIALIZING=0,BUFFERING=1,PLAYING=2,PAUSED=3,MODE_LERP=0,MODE_HERMITE=1,vectorPool=[],quatPool=[],framePool=[],getPooledVector=()=>vectorPool.shift()||new THREE.Vector3,getPooledQuaternion=()=>quatPool.shift()||new THREE.Quaternion,getPooledFrame=()=>{let a=framePool.pop();return a||(a={position:new THREE.Vector3,velocity:new THREE.Vector3,scale:new THREE.Vector3(1,1,1),quaternion:new THREE.Quaternion,wrotePosition:!1,wroteVelocity:!1,wroteScale:!1,wroteQuaternion:!1,time:0}),a},freeFrame=a=>{a.wrotePosition=a.wroteVelocity=a.wroteScale=a.wroteQuaternion=!1,framePool.push(a)},almostEqualVec3=function(a,b,c){var d=Math.abs;return d(a.x-b.x)<c&&d(a.y-b.y)<c&&d(a.z-b.z)<c},almostEqualQuat=function(a,b,c){var d=Math.abs;return d(a.x-b.x)<c&&d(a.y-b.y)<c&&d(a.z-b.z)<c&&d(a.w-b.w)<c};class InterpolationBuffer{constructor(a=MODE_LERP,b=.15){this.state=INITIALIZING,this.buffer=[],this.bufferTime=1e3*b,this.time=0,this.lastTailCopyFrame=null,this.mode=a,this.originFrame=getPooledFrame(),this.position=null,this.quaternion=null,this.scale=null}hermite(a,b,c,d,e,f){const g=b*b,h=b*b*b;a.copy(c.multiplyScalar(2*h-3*g+1)),a.add(d.multiplyScalar(-2*h+3*g)),a.add(e.multiplyScalar(h-2*g+b)),a.add(f.multiplyScalar(h-g))}lerp(a,b,c,d){a.lerpVectors(b,c,d)}slerp(a,b,c,d){THREE.Quaternion.slerp(b,c,a,d)}updateOriginFrameToBufferTail(){freeFrame(this.originFrame),this.originFrame=this.buffer.shift()}appendBuffer(a,b,c,d){const e=0<this.buffer.length?this.buffer[this.buffer.length-1]:null;if(e&&e.time===this.time)null!==a&&(e.position.copy(a),e.wrotePosition=!0),null!==b&&(e.velocity.copy(b),e.wroteVelocity=!0),null!==c&&(e.quaternion.copy(c),e.wroteQuaternion=!0),null!==d&&(e.scale.copy(d),e.wroteScale=!0);else{const f=e||this.originFrame,g=getPooledFrame();(null!==a||f.wrotePosition)&&(g.position.copy(a||f.position),g.wrotePosition=!0),(null!==b||f.wroteVelocity)&&(g.velocity.copy(b||f.velocity),g.wroteVelocity=!0),(null!==c||f.wroteQuaternion)&&(g.quaternion.copy(c||f.quaternion),g.wroteQuaternion=!0),(null!==d||f.wroteScale)&&(g.scale.copy(d||f.scale),g.wroteScale=!0),g.time=this.time,this.buffer.push(g)}this.state===PAUSED&&(this.state=PLAYING)}setTarget(a,b,c,d){this.appendBuffer(a,b,c,d)}setPosition(a,b=null){this.appendBuffer(a,b,null,null)}setQuaternion(a){this.appendBuffer(null,null,a,null)}setScale(a){this.appendBuffer(null,null,null,a)}update(a,b){var c=Math.abs;let d,e,f;if(this.state===INITIALIZING&&0<this.buffer.length){this.updateOriginFrameToBufferTail();const{position:a,wrotePosition:b,quaternion:c,wroteQuaternion:g,scale:h,wroteScale:i}=this.originFrame;b&&(null===this.position?this.position=new THREE.Vector3(a.x,a.y,a.z):this.position.copy(a),d=!0),g&&(null===this.quaternion?this.quaternion=new THREE.Quaternion(c.x,c.y,c.z,c.w):this.quaternion.copy(c),e=!0),i&&(null===this.scale?this.scale=new THREE.Vector3(h.x,h.y,h.z):this.scale.copy(h),f=!0),this.state=BUFFERING}if(this.state===BUFFERING&&0<this.buffer.length&&this.time>this.bufferTime&&(this.state=PLAYING),this.state===PAUSED){const b=this.buffer[0];return b.time=this.time+a,!1}if(this.state===PLAYING){let g=!1;const h=this.time-this.bufferTime;for(;0<this.buffer.length&&h>this.buffer[0].time;)if(1<this.buffer.length)this.updateOriginFrameToBufferTail();else{const b=this.buffer[0];b.wrotePosition&&(this.originFrame.position.copy(b.position),g=!0),b.wroteVelocity&&(this.originFrame.velocity.copy(b.velocity),g=!0),b.wroteQuaternion&&(this.originFrame.quaternion.copy(b.quaternion),g=!0),b.wroteScale&&(this.originFrame.scale.copy(b.scale),g=!0),g&&(this.originFrame.time=b.time,b.time=this.time+a)}if(0<this.buffer.length&&0<this.buffer[0].time){const a=this.buffer[0],i=a.time-this.originFrame.time,j=(h-this.originFrame.time)/i;if(this.originFrame.wrotePosition&&a.wrotePosition&&(b&&(c(a.position.x-this.originFrame.position.x)>b||c(a.position.y-this.originFrame.position.y)>b||c(a.position.z-this.originFrame.position.z)>b)?null===this.position?this.position=new THREE.Vector3(a.position.x,a.position.y,a.position.z):this.position.set(a.position.x,a.position.y,a.position.z):this.mode===MODE_LERP?(null===this.position&&(this.position=new THREE.Vector3),this.lerp(this.position,this.originFrame.position,a.position,j)):this.mode===MODE_HERMITE&&(null===this.position&&(this.position=new THREE.Vector3),this.hermite(this.position,j,this.originFrame.position,a.position,this.originFrame.velocity.multiplyScalar(i),a.velocity.multiplyScalar(i))),d=!0),this.originFrame.wroteQuaternion&&a.wroteQuaternion&&(null===this.quaternion&&(this.quaternion=new THREE.Quaternion),this.slerp(this.quaternion,this.originFrame.quaternion,a.quaternion,j),e=!0),this.originFrame.wroteScale&&a.wroteScale&&(null===this.scale&&(this.scale=new THREE.Vector3),this.lerp(this.scale,this.originFrame.scale,a.scale,j),f=!0),g){const b=!a.wrotePosition||null!==this.position&&almostEqualVec3(this.position,a.position,1e-4),c=!a.wroteQuaternion||null!==this.quaternion&&almostEqualQuat(this.quaternion,a.quaternion,.001),d=!a.wroteScale||null!==this.scale&&almostEqualVec3(this.scale,a.scale,1e-4);b&&c&&d&&(this.state=PAUSED)}}}return this.state!==INITIALIZING&&(this.time+=a),d||e||f}getPosition(){return this.position}getQuaternion(){return this.quaternion}getScale(){return this.scale}}module.exports=InterpolationBuffer;
